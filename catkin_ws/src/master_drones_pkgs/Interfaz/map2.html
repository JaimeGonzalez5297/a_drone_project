<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  </head>
  <body>
    <div id="map" style="height: 100%; width: 100%"></div>
    <script>


      var c = 0;
      var map = L.map('map').setView([3.4154936, -76.5183181], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);


      var myIcon = L.icon({
        iconUrl: 'icons/feather/download.svg',
        iconSize: [24, 24]
      });
      
      var drawControl = new L.Control.Draw({
        draw: {
          polygon: {
            allowIntersection: false,
            showArea: true,
            metric: ['km', 'm'],
            drawError: {
              color: '#FF0000',
              timeout: 1000
            },
            shapeOptions: {
              color: '#00FF00'
            }
          },
          marker: {
            icon: new L.Icon.Default()
          }
        },
        edit: {
          featureGroup: drawnItems,
          remove: true
        }
      });

      drawControl.setDrawingOptions({
        circle: false,
        rectangle: false,
        polyline: false,
        circlemarker: false
      })

      map.addControl(drawControl);
      
      var linePoints = [];

      var datos = {"wp_region":{},"area":{},"wp_recarga":{}}

      map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer,coords;
        var jsonLayer = layer.toGeoJSON();
        var tipo = jsonLayer.geometry.type;
        drawnItems.addLayer(layer);  
        if (tipo =="Polygon") {
          var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0])
          datos.wp_region = jsonLayer.geometry.coordinates;
          datos.area= area
        }
        if (tipo == "Point"){
          datos.wp_recarga = jsonLayer.geometry.coordinates;
        }
        var coords = JSON.stringify(datos);
        enviarinfo(coords);
        
      });

      function enviarinfo(mensaje){
        const websocket = new WebSocket("ws://localhost:8765");
        websocket.onopen = function() {
        websocket.send(mensaje);
        };

        websocket.onmessage = function(event) {
          if (event.data == "last"){
            L.polyline(linePoints, {color: 'red'}).addTo(map);
          }
          else {
            var dato = event.data
            var sin_comillas = dato.slice(1,-1)
            var tupla = sin_comillas.split(",")
            var latitud=Number(tupla[0])
            var longitud=Number(tupla[1])
            var wp= [latitud,longitud]
            L.marker(wp).addTo(map);
            linePoints.push(wp);
          }
        };

        websocket.onclose = function(event) {
          console.log("WebSocket disconnected!");
        };
      }
      
    </script>
  </body>
</html>